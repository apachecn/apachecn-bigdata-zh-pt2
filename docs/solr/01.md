# 一、Apache Solr：简介

Electronic supplementary material The online version of this chapter (doi:[10.​1007/​978-1-4842-1070-3_​1](http://dx.doi.org/10.1007/978-1-4842-1070-3_1)) contains supplementary material, which is available to authorized users.

搜索无处不在，已经成为我们数字生活的一部分！你打开浏览器，很有可能你的主页是你首选的搜索引擎。你智能手机的搜索引擎只是轻轻一扫。打开一个电子商务网站，搜索框就出现在页面的中央或顶部。基本上，每个需要公开数据的门户都需要一个搜索引擎。这证明了一个搜索引擎对于一个企业或者它正在构建的产品是多么的重要。

当今的企业有大量的信息要公开，而且这一数量还将继续增长。浏览所有数据以找到相关信息几乎是不可能的，也是乏味的。这个问题的唯一解决方案是搜索引擎。

如果你有大量的数据，却很难在需要的时候以你需要的方式找到你想要的信息，那么这些数据几乎毫无价值，是时候呼吁开发或升级你的搜索引擎了。因为您正在阅读这一章，我假设您正在构建或计划构建一个搜索引擎，并且您理解为什么您的企业需要一个搜索引擎。所以事不宜迟，我们继续吧。

本书的目标是帮助你使用开源的 Apache Solr 开发一个搜索引擎。首先，你需要明白每个搜索引擎都是不同的，都有自己独特的挑战，需要以不同的方式解决。我们将探讨常见问题及其解决方案，并提供解决本书流程中特定问题的方法。

本章首先介绍了 Apache Solr，并提供了其特性的高级视图。它涉及到 Solr 的几个方面，以便您在开始概念证明或开发之前有一个全面的了解。

本章涵盖以下主题:

*   Solr 的重要特性
*   Solr 的重要组成部分
*   Solr 的使用超出了它的搜索引擎功能
*   Solr 与其他解决方案的比较
*   Solr 生态系统中使用的技术

## 概观

Solr(发音为 solar)是一个企业级的、速度惊人的、高度可伸缩的搜索平台，使用 Apache Lucene 构建。经过多年的发展，有了这样一个充满活力的社区，Solr 已经成熟到了这样一个水平，它提供了开箱即用的所有急需的特性以及定制它的条款。它是云就绪型的，具有强大的健壮性、容错性和可靠性。

Solr 是用 Java 编写的，作为独立的服务器运行。入门极其容易。您所需要做的就是运行一个带有启动/停止命令的脚本。由于 Solr 完全基于配置，所以它只要求您互相注册组件。即使没有任何 Java 知识，你也可以构建一个像样的搜索引擎，只要你不需要定制。Solr 还提供了一个易于监控的图形管理员界面，可以通过指向运行搜索引擎的端口从浏览器访问该界面。

Note

Apache Lucene 是一个流行的完全用 Java 编写的开源搜索库。它广泛用于索引大量文档和支持全文搜索。

## 内部 Solr

要选择一个框架，您需要从内部、特性、功能、可用性、性能和可伸缩性等方面进行评估。这一节将回答您的一些问题，包括 Solr 内部有什么，如何配置它，以及如何使用它。本节介绍的特性可能不是 Solr 如此受欢迎的原因，但是作为您对 Solr 基本理解的一部分，了解这些特性是很重要的。下一节将介绍使 Solr 流行的特性，这样您将对 Solr 的特性有全面的了解。以下几点提供了 Solr 特性的快速概述:

*   倒排索引:Lucene 为您添加到 Solr 中的文档构建倒排索引，并在查询时搜索匹配的文档。你可以把倒排索引想象成类似于本书末尾的索引。
*   向量空间模型:默认情况下，Lucene 使用向量空间模型(VSM)和布尔模型来确定文档与用户查询的相关性。简而言之，布尔模型认可，VSM 排名。
*   基于配置:`solrconfig.xml`和`schema.xml`是 Solr 的两个主要配置文件。`schema.xml`文件主要定义模式中的字段以及这些字段的行为(在索引和查询时文本将如何被标记)。其他的几乎都进`solrconfig.xml`了。您也可以不使用模式，让 Solr 在索引数据时自动创建字段。这些配置可以手动编辑，也可以通过调用相应的 API 来动态修改。从 Solr 5.0 开始，您甚至可以通过 API 调用上传 JAR 文件。
*   分析链:您的搜索查询和被索引的文档经过一系列分析器和标记器(一个标记器的输出被提供给链中的另一个标记器)。最后一个标记器的输出是被索引和匹配的术语。
*   Java: Solr 和 Lucene 都是用 Java 写的。Solr 5.0 需要 Java 7+才能运行。要定制 Solr 的任何特性，您需要扩展适当的 Java 类。
*   SolrJ: Solr 捆绑了一个 Java 客户端库，可以用来索引文档和查询结果。库也可用于其他语言，如 Perl 和 Python。

## 是什么让 Apache Solr 如此受欢迎

Apache Solr 是使用最广泛的搜索解决方案之一，每月有数百万次下载，数万个应用程序在生产中，数百次提交。以下是使它如此受欢迎的一些因素:

*   Lucene: Solr 在其核心使用 Lucene 搜索库，并对其进行包装以添加特性，并将其公开为可以通过 HTTP 访问的 RESTful 服务。Solr 和 Lucene 的开发在 2010 年 3 月合并，两者的代码库都驻留在 Apache Subversion (SVN)的同一个主干中；因此，你一定会在最新的 Solr 版本中获得所有最新的 Lucene 特性。
*   高可伸缩性和容错性:您可以添加或删除 Solr 的计算能力，只需根据需要添加或删除实例的副本。SolrCloud 甚至将您的应用程序抽象为不知道数据是如何分布的，并使您免于陷入进一步的细微差别，如负载平衡和分片。索引到 Solr 的数据可以在多个实例之间复制；因此，即使一个实例关闭，数据仍然可以访问。
*   企业就绪:Solr 在搜索需求和处理大量负载方面得到了许多领先组织的充分证明和信任。它可以部署在独立的传统分布式架构中，也可以根据组织的需求部署在云模式中，无论组织规模大小。
*   全文搜索:由于 Solr 构建在 Lucene 之上，它提供了所有需要的匹配功能，包括令牌、短语、模糊、通配符、拼写检查和自动完成。
*   基于 HTTP 的 RESTful XML/JSON:Solr 作为 RESTful web 服务公开，可以通过 HTTP 访问。数据可以以 XML、JSON、CSV 和二进制格式交换。
*   灵活且可扩展:Solr 具有开箱即用的多种功能。尽管如此，如果它不符合你的需求，也不用担心；Solr 是灵活和可扩展的。您可以通过扩展 Java 类并在适当的文件中添加所创建类的配置来修改和定制组件的行为。
*   容易配置:如果你知道你的模式，你可以预定义它；否则，您可以选择无模式，让 Solr 定义字段。此外，您可以通过 API 调用来修改您的配置。
*   全面的管理界面:这是另一个使 Solr 相当容易使用的特性。Solr 提供了一个功能强大、用户友好的界面，可以在浏览器中通过 HTTP 访问。它提供了几乎所有需要的洞察力，使您能够查看配置文件；检查文本分析；添加/删除碎片；实时管理日志；搜索、添加、删除和更新文档。触发数据导入流程；查看线程和系统属性；还有很多。
*   充满活力的社区:Solr 是 Apache Software Foundation (ASF)的一个项目，拥有一个由 100 多名开发人员和提交人员组成的充满活力且不断发展的社区。每个版本都添加了许多功能，并进行了改进。该项目已经成熟到这样一个水平，它有一个令人难以置信的多才多艺的功能集。

## 主要构件

Solr 和 Lucene 的类是有组织和分层的。每个都被设计成执行特定的工作。您所需要做的就是在配置文件中对它们进行适当的配置，这样它们就可以根据需要相互注册。Solr 还允许您编写自定义组件并将其插入。概括地说，以下是 Solr 的一些主要构建块和重要组件:

*   请求处理程序:所有对 Solr 的请求都由实现`SolrRequestHandler`的一个类来处理。您将处理程序配置为映射到一个特定的 URI 端点，向该端点发出的请求开始由它提供服务。
*   搜索组件:搜索组件定义了实现搜索处理程序提供的特性的逻辑。这些组件应该在一个`SearchHandler`中注册，这是一个服务于用户查询的请求处理器。例如，查询、拼写检查、分面和点击突出显示等功能作为组件实现，并注册到 SearchHandler。多个组件可以注册到一个搜索处理程序。
*   查询解析器:它将用户查询翻译成 Lucene 能够理解的指令。它们通常注册在`SearchComponent`中，这个组件定义了执行搜索的逻辑。
*   相似性:这个类决定 Lucene 如何对术语进行加权和对文档进行评分。如果你想改变评分行为，这就是要扩展的类。
*   响应编写器:这决定了应该如何格式化对用户查询的响应。对于每种响应类型，比如 XML、JSON 或 Velocity，都有一个单独的响应编写器。
*   分析器/标记器:Lucene 理解的最小数据单元是一个标记。`Analyzer`、`tokenizer`或`TokenFilter`的实现决定如何将文本分解成记号。
*   更新请求处理器:在索引文档时，您可以调用一组`UpdateRequestProcessor`作为链的一部分，对数据执行定制操作。

## 历史

2004 年，Solr 作为一个内部项目由 CNET 的 Yonik Seeley 创建。2006 年初，CNET 将这个项目捐赠给了 Apache 软件基金会。经过一段时间的孵化，Solr 被释放。随着时间的推移，分布式搜索、点击突出显示、增强的搜索和索引功能、分面、拼写检查、云功能和无数其他功能已经添加进来，使其用户、贡献者和提交者社区成为当今最有活力的社区之一。以下说明了 Solr 是如何成熟的:

*   Solr 1.x:这是该产品的企业级版本。Solr 1.3 于 2007 年 1 月发布。Solr 1.4 于 2009 年 11 月发布，增强了索引、搜索、复制、富文档索引和更好的数据库集成。
*   Solr 3 . x:2011 年 3 月，Solr 和 Lucene 项目的开发合并，所以没有 Solr 的 2.x 版本。Solr 的下一个版本直接标记为 3.1，以匹配 Lucene 版本。Solr 3.x 专注于空间搜索等新特性，以及处理管道的 UIMA、UI 的 Velocity 等集成。
*   Solr 4.x: Solr 4.0 主要是关于分布式搜索和 SolrCloud，使 Solr 更加可靠、容错和可伸缩。
*   Solr 5.x: Solr 5.0 于 2015 年 2 月发布，重点是易用性和硬化。最近的版本集中在安全性、分析和扩展 API 上。有关详细信息，请参考下一节。

## Solr 5.x 的新特性

Solr 4.x 引入了 SolrCloud，这是一种面向分布式搜索和可伸缩性的新方法和设计。5.x 版将 Solr 作为一个独立的服务器，有以下主要变化:

*   独立服务器:如果你是 Apache Solr 的现有用户，是时候从新的角度来看待它了。它不再以 WAR (web archive)文件的形式分发，您应该将它部署在您最喜欢的 servlet 容器中，而是作为一个独立的服务器，您应该使用它来解决您的业务问题，而不必担心部署细节。这样做是为了更好地利用容器的网络堆栈功能。
*   易用性:Solr 5.0 更容易上手和使用。启动、停止和将 Solr 公开为服务就像运行一个命令一样简单。它还提供了更好的自我发现，更有组织性，甚至更可配置。通过使用 AngularJS 对管理 UI 进行了重构，以获得更好的用户体验。
*   分布式 IDF:反向文档频率，Solr 评分中最重要的因素之一，现在可以全局计算。
*   新的 API:引入了新的 API，并且扩展了现有的 API。JSON 请求 API 允许搜索请求有一个 JSON 主体。
*   安全性:Solr 5.2.0 引入了一个可插拔的认证模块，并提供了一个基于 Kerberos 的插件。还提供了授权框架。
*   分析:facets 模块已经扩展到支持分析和聚合。
*   Clusterstate 拆分:将`clusterstate`拆分为每个集合使得 SolrCloud 更具可伸缩性。集群将只知道它需要知道的东西，而不是所有东西。

## 超越搜索器

Solr 的发展已经超越了它的搜索引擎能力，可以作为一个数据存储来使用。如果您将 Solr 用于索引和搜索需求，并且还需要一个数据存储，那么将 Solr 作为一个替代的 NoSQL 解决方案是值得考虑的。MongoDB 等 NoSQL 解决方案支持全文搜索，因此它们可以满足您简单的搜索需求。类似地，Solr 可以用作数据存储，尽管这不是它的主要用例。Lucene 中的更新是以删除和添加的方式实现的，可能不适合需要频繁更新的系统。此外，在选择 NoSQL 数据库时，会对许多参数进行评估。不幸的是，这方面的讨论超出了本书的范围。

此外，Solr 可以用作简单需求的分析工具，比如计数、切片和分组。一个数据分析系统必须能够处理大量的数据，Solr 是一种经过验证的快速技术。因此，您可以使用 Solr 对索引数据执行一些分析。Solr 4.9 允许您通过 AnalyticsQuery API 插入自定义的分析算法。Solr 5.0 通过搜索分析组件支持开箱即用的 OLAP 操作。Solr 5.2 支持 HyperLogLog，这是一种计算不同值的概率方法。

## Solr 与其他选项

本节将 Solr 与关系数据库和 Elasticsearch 进行比较。我选择将 Solr 与关系数据库进行比较，以便刚接触搜索和 NoSQL 的开发人员能够从数据库的角度理解和理解 Solr。相比之下，Elasticsearch 是另一个流行的开源搜索引擎，它的比较可以帮助你了解 Solr 与它的关系，以及你是否应该评估 Elasticsearch 以供你使用。

### 关系数据库

传统的 SQL 数据库被设计为查询表以找到匹配的结果，并且不具有对这些结果进行排序的能力。当你开发你的搜索引擎时，你希望你的搜索结果在一定的基础上被排序，并解释为什么一个特定的文档排在一个特定的位置或在另一个文档之上。例如，基于诸如文档中匹配的标记的最大数量、语料库中标记的稀有性、文档是最新的、或其他参数的组合等逻辑，文档可以排在结果集的顶部。以下是 Solr 和传统数据库之间的一些主要区别:

*   相关性排序:Solr 排序基于布尔模型和向量空间模型的组合。布尔模型批准文档，并使用 VSM 对那些批准的文档进行排名。相比之下，传统数据库只找到应该构成结果集一部分的文档；他们只有审批流程，没有对文档进行排序的规定。
*   规范化与非规范化:关系数据库中的数据应该是规范化的，并且在表之间建立一种关系。但是 Solr 中的数据是非规范化和扁平化的。Solr 确实支持连接，但是其行为和实现是不同的，并且不如表连接强大。如果数据存储在一个表中，并且要导入到 Solr 中，那么应该由索引器程序或 Solr 的 dataimport contrib 模块对其进行反规范化。
*   模式与无模式:关系数据库需要在创建表时定义一个模式。如果您想要添加一个新列，则需要修改该表。但是 Solr 是灵活的。如果您知道您的模式，您可以在配置文件中定义它，或者您可以选择无模式。
*   纵向扩展与横向扩展:Solr 在企业系统中表现出色并取得优势的一个方面是它易于横向扩展。关系数据库很难向外扩展；它们通常会扩大规模，但成本很高。在传统的 Solr 架构中，数据可以被分发和分片。SolrCloud 使向外扩展变得更加容易，并且可以在商用机器集群上运行。
*   文本分析和导航:Solr 提供了灵活的文本分析和导航特性，这对于开发搜索引擎非常有意义。这些特性在传统数据库中是完全没有的。

这里需要理解的重要一点是，最好将 Solr 用作从主数据存储(如传统数据库)导入数据的辅助数据存储。每当您对索引过程进行更改或升级 Solr 版本(或类似的版本)时，您可能需要从头开始构建索引。拥有主数据存储简化了重新编制索引的过程。

### 弹性搜索

Elasticsearch 是一个流行且广泛使用的开源搜索引擎。Solr 和 Elasticsearch 都建立在 Lucene 之上，拥有活跃的社区，并且有商业背景。不同之处在于它们在 Lucene 之上构建包装器和实现特性的方式。以下是它们的一些主要区别:

*   Lucene:根据 Lucene 搜索 Solr aces Elasticsearch。因为 Solr 和 Lucene 的开发是合并的，所以 Solr 总是和 Lucene 有相同的版本。有了 Solr，你总能得到最新版本的 Lucene，而 Elasticsearch 可能会落后几个版本。在撰写本章时，Solr 5.3.1 运行 Lucene 5.3.1，而 Elasticsearch 1.6.0 运行 Lucene 4.10.4。
*   开源:Solr 和 Elasticsearch 都是开源的。然而，Solr 是 Apache 软件基金会的一个项目，因此是真正意义上的开源；甚至你也可以是一个委托人。Elasticsearch 由它的创始公司 Elastic 提供支持，只有他们的员工才能提交。
*   历史:Solr 于 2006 年开源，当时是唯一流行的开源搜索引擎。Elasticsearch 于 2010 年发布，尽管它比较年轻，但它已经变得非常流行和广泛使用。
*   分布式和可伸缩性:Solr 最初关注的是与查询、分面等相关的核心搜索问题和特性。它支持传统主从结构形式的分布式搜索。Elasticsearch 发布时采用了真正分布式和可伸缩的架构，这是它的主要优势。后来 Solr 4.0 开始用 SolrCloud 支持分布式和可伸缩的架构。
*   集群管理:Solr 使用 Apache ZooKeeper，这是一个非常流行和成熟的配置维护解决方案。反过来，Elasticsearch 有一个内置的框架，名为 Zen Discovery，更容易受到裂脑问题的影响。在裂脑场景中，一个集群指定两个主服务器，这会导致数据丢失。
*   REST 端点:两者都公开 REST 端点。Elasticsearch 纯粹是 JSON in 和 JSON out，而 Solr 支持多种格式，包括 XML、JSON、CSV 和 binary。
*   推送查询:过滤是 Elasticsearch 的一个特性，当新文档符合您指定的条件时，它会通知应用程序。Solr 不支持推送查询。
*   分析、监控和度量:Solr 更关注文本搜索和支持特性。但在分析和监控方面，Elasticsearch 表现出色。它提供了无数的监控选项，而 Solr 中的支持是有限的。ELS 堆栈(Elasticsearch、Logstash 和 Kibana 组合在一起)允许您实时获得可操作的见解。栈广泛用于与日志管理相关的需求。
*   文本分析:在 Solr 中，应该使用托管 API 来预定义或配置分析器。在 Elasticsearch 中，甚至可以在查询时设置分析器。
*   易用性:Elasticsearch 一直很容易上手和运行，但最近的 Solr 5.0 也不甘落后。如果您在无模式模式下运行 Solr，索引和搜索只是一个两步过程:下载和开始。但是 Solr 一般期望你配置两个 XML 文件，`schema.xml`和`solrconfig.xml`。这些文件有很好的文档记录，但需要一些理解，从长远来看，这可以提供更好的可管理性。

## 相关技术

通过本书的课程，在为你的需求开发解决方案时，你会遇到一些相关的项目。我在整本书中尽可能详细地介绍了这些项目。如果您想更深入地了解它们，请参考它们各自的手册。这些项目如下:

*   阿帕奇动物园管理员:这个控制着 SolrCloud 的心跳。它是一个中央服务，用于以容错和高度可用的方式维护集群配置、存储状态和同步信息。要使 SolrCloud 正常工作，至少应该有一个 ZooKeeper 实例启动并运行。
*   Apache OpenNLP:这是一个 Java 库，用于文本的自然语言处理。它支持理解和解释人类语言文本的任务。在这本书里，你将学会应用这些技术来构建一个强大的搜索引擎。
*   阿帕奇·UIMA:如果你的数据是非结构化的，Solr UIMA 贡献模块可以用来给数据结构化。UIMA 允许我们定义一个定制的管道来分析大量的非结构化文本，并对提取的元数据进行注释，这些元数据可以添加到 Solr 字段中。
*   Carrot clustering:通过使用 Carrot2，可以将相似或语义相关的搜索结果聚集在一起，只需对 XML 配置做一些修改就可以做到这一点。
*   Apache Tika:这个工具包提供了一个框架，用于从许多不同格式的文件(如 Word、PPT 和 PDF)中解析和提取内容和元数据。Solr 提供了一个 Solr Cell 框架，它使用这个工具包来索引这些文件的内容和元数据。

## 摘要

本章简要介绍了 Apache Solr，概述了 Solr 的内容，Solr 如此受欢迎的原因，以及为什么应该在项目中使用它。我还简要介绍了 Solr 的新特性。随着 Solr 目前的成熟，它不仅仅局限于作为一个搜索引擎，还被广泛用作 NoSQL 数据库和分析引擎。

下一章将介绍如何设置 Solr 以及内部的工作原理。第 3 章是关于信息检索的概念和搜索引擎如何工作的内部原理，独立于其他章节，可以不按顺序阅读。

## 资源

Apache Solr 的官方网站是 [`http://lucene.apache.org/solr/`](http://lucene.apache.org/solr/) 。Solr 的最新版本可以从这个位置下载。随着每个二进制版本的发布，Solr 提供了特定于该版本的官方文档、变更的细节和 Javadocs。

Solr cwiki ( [`https://cwiki.apache.org/confluence/display/solr/Apache+Solr+Reference+Guide`](https://cwiki.apache.org/confluence/display/solr/Apache+Solr+Reference+Guide) )和 wiki ( [`https://wiki.apache.org/solr/`](https://wiki.apache.org/solr/) )是在线 Solr 信息的两个主要来源。cwiki 是一个由 ASF 社区维护的合流站点，所有的提交都由 Solr 提交者执行。现有的信息是经过官方批准和核实的。如果你对任何 cwiki 页面有任何建议，请随意添加评论。提交者将根据建议做出响应或做出适当的更改。

Solr wiki 是一个易于编辑的网页集合，由社区维护，托管在 MoinMoin web 引擎上。任何有权限的人都可以编辑页面。如果你想要编辑权限，写信给 Solr 邮件列表或 IRC 频道。

如需提问、讨论问题或为社区做出贡献，请参考位于 [`http://lucene.apache.org/solr/resources.html`](http://lucene.apache.org/solr/resources.html) 的 Solr 资源页面了解更多信息。